# 爬虫vs批量下载：技术方案对比

## 问题背景

国家法律法规数据库（flk.npc.gov.cn）使用了特殊的文件格式：

- **OFD格式**：类似PDF的开放文档格式
- **内容在iframe中**：法律全文通过OFD阅读器加载
- **无直接HTML文本**：无法通过简单爬虫直接获取法条文本

## 关键发现

通过浏览器分析发现：
```
法律详情页 → iFrame (flkofd.npc.gov.cn) → OFD文件
```

这意味着：
1. 页面HTML中没有法律全文
2. 内容动态加载在OFD阅读器iframe中
3. 需要解析OFD文件才能获取文本

## 方案对比

### 方案1：批量下载工具（当前）

**流程**:
```
Selenium → 点击"法律"分类 → 全选 → 批量下载 → 获得OFD/DOC文件
```

**优点**:
- ✅ 获得官方完整文件（OFD/DOC格式）
- ✅ 可以离线保存原始文件
- ✅ 文件格式规范，便于后续处理

**缺点**:
- ❌ 元素定位困难（网页使用Vue框架，动态渲染）
- ❌ 运行速度慢（每页需要等待加载）
- ❌ 依赖浏览器（ChromeDriver版本匹配问题）
- ❌ 不稳定（页面结构变化会导致失败）

**当前问题**:
- 无法定位"全选"复选框
- 无法定位"批量下载文件"按钮
- 无法定位"每页条目数"选择器

---

### 方案2：爬虫（HTTP请求）

**流程**:
```
爬虫 → 法律列表页 → 解析法律信息 → 详情页 → 下载OFD文件 → 解析OFD
```

**优点**:
- ✅ 不依赖浏览器
- ✅ 运行速度快
- ✅ 代码简单、易维护
- ✅ 可以获取所有法律的元数据

**缺点**:
- ❌ 详情页没有HTML文本，只有OFD文件
- ❌ 需要下载和解析OFD文件
- ❌ OFD解析可能复杂

**技术栈**:
```python
requests + BeautifulSoup  # 获取列表
+ ofdparser               # 解析OFD文件（如果有这样的库）
```

---

### 方案3：混合方案（推荐）

结合两者优势，分步骤实现：

#### 阶段1：获取法律列表
**使用爬虫**获取所有法律的基本信息
```python
# 获取法律列表
laws = [
    {
        'title': '中华人民共和国公司法',
        'url': '/detail/xxx.html',
        'doc_number': '主席令第15号',
        'publish_date': '2023-12-29'
    },
    ...
]
```

#### 阶段2：下载文件
**两种方式任选其一**:

**方式A**: 使用爬虫下载（如果能找到直接下载链接）
```python
# 分析详情页，找到下载链接
download_url = get_download_url(law_url)
download_file(download_url)
```

**方式B**: 使用Selenium逐个下载
```python
# 对于每个法律，访问详情页，点击下载
for law in laws:
    selenium.get(law['url'])
    selenium.click('下载按钮')
```

#### 阶段3：解析文件
```python
# 解析OFD或DOC文件，提取法条
articles = parse_ofd_file(file_path)
db.insert(law, articles)
```

---

## 推荐实施步骤

### 第一步：测试直接下载

检查是否有直接下载链接：

```python
# 测试代码
import requests
from bs4 import BeautifulSoup

url = "https://flk.npc.gov.cn/detail/xxxx"
response = requests.get(url)
soup = BeautifulSoup(response.text, 'html.parser')

# 查找下载链接
download_links = soup.find_all('a', text=['下载', 'WPS版本', 'PDF版本'])
for link in download_links:
    print(link.get('href'))
```

### 第二步：如果有直接下载链接

使用爬虫方案：
1. 爬取法律列表
2. 对每个法律获取下载链接
3. 下载文件
4 解析文件
5. 存入数据库

### 第三步：如果没有直接下载链接

优化Selenium方案：
1. 增加等待时间
2. 使用JavaScript直接操作（已实现）
3. 添加更详细的调试日志
4. 逐个下载而不是批量下载

---

## OFD文件解析

如果下载的是OFD格式，需要解析工具：

**Python库选项**:
1. `ofdreader` - 如果有这样的库
2. 转换工具：OFD → PDF → 文本
3. 调用Java库（OFD是中文标准，Java支持较好）

**备选方案**:
- 使用OCR识别（如果必要）
- 使用WPS版本（DOC格式更易解析）

---

## 最终建议

### 短期方案（快速验证）

1. **先修复批量下载工具**
   - 使用非无头模式，手动观察页面
   - 找到正确的元素选择器
   - 先下载少量文件测试

2. **测试文件格式**
   - 看下载的是OFD还是DOC
   - 测试能否解析

### 长期方案（生产环境）

1. **使用爬虫获取列表** - 快速、稳定
2. **使用API或直接下载** - 如果找到下载链接
3. **备选Selenium** - 如果只能通过浏览器下载
4. **解析并入库** - 统一处理所有文件

---

## 需要决策的问题

1. **您更关心哪个**：
   - ✅ 快速获得数据（爬虫优先）
   - ✅ 获得完整文件（批量下载优先）

2. **文件格式偏好**：
   - OFD（官方格式）
   - DOC/DOCX（易于解析）
   - 纯文本（最方便）

3. **数据量要求**：
   - 少量测试（100部法律）
   - 中等（500部法律）
   - 完整（1000+部法律）

---

## 下一步行动

我建议：

1. **立即测试**：检查是否有直接下载链接
2. **如果有**：使用爬虫方案（2天完成）
3. **如果没有**：优化Selenium批量下载（3-5天调试）

您想先测试哪个方案？
